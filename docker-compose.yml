services:
  backend:
    image: ghcr.io/marcodroll/familyflow-backend:latest
    container_name: familyflow-backend
    environment:
      PORT: 3000
      NODE_ENV: production
    volumes:
      - sqlite_data:/app/data
    networks:
      - familyflow-network
    restart: unless-stopped

  frontend:
    image: ghcr.io/marcodroll/familyflow-frontend:latest
    container_name: familyflow-frontend
    depends_on:
      - backend
    networks:
      - familyflow-network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: familyflow-nginx
    ports:
      - "80:80"
    configs:
      - source: nginx_config
        target: /etc/nginx/nginx.conf
    depends_on:
      - frontend
      - backend
    networks:
      - familyflow-network
    restart: unless-stopped

configs:
  nginx_config:
    content: |
      events {
          worker_connections 1024;
      }

      http {
          upstream backend {
              server backend:3000;
          }

          upstream frontend {
              server frontend:80;
          }

          server {
              listen 80;
              server_name localhost;

              location /api/ {
                  proxy_pass http://backend/api/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  proxy_cache_bypass $$http_upgrade;
              }

              location / {
                  proxy_pass http://frontend/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $$host;
                  proxy_cache_bypass $$http_upgrade;
              }
          }
      }

volumes:
  sqlite_data:
    name: familyflow_sqlite

networks:
  familyflow-network:
    driver: bridge
